<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Section Management - KLH</title>
    <link rel="stylesheet" href="css/roomsync.css">
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <h1 class="logo">üìö Section Management</h1>
                <nav class="nav-menu">
                    <a href="dashboard.html" class="nav-link">Dashboard</a>
                    <a href="rooms.html" class="nav-link">Rooms</a>
                    <a href="sections.html" class="nav-link active">Sections</a>
                    <a href="allocations.html" class="nav-link">Allocations</a>
                </nav>
                <div class="user-info">
                    <span id="userName" class="user-name"></span>
                    <span id="userRole" class="user-role-badge"></span>
                    <button id="logoutBtn" class="btn-secondary">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header">
                <div>
                    <h2>Section Management</h2>
                    <p class="subtitle">Register and manage class sections</p>
                </div>
                <button id="addSectionBtn" class="btn-primary">
                    ‚ûï Add New Section
                </button>
            </div>

            <!-- Filters -->
            <div class="filters-card">
                <div class="filter-group">
                    <label>Department</label>
                    <select id="filterDepartment" class="filter-select">
                        <option value="">All Departments</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Time Slot</label>
                    <select id="filterTimeSlot" class="filter-select">
                        <option value="">All Time Slots</option>
                        <option value="8:00 AM - 9:00 AM">8:00 AM - 9:00 AM</option>
                        <option value="9:00 AM - 10:00 AM">9:00 AM - 10:00 AM</option>
                        <option value="10:00 AM - 11:00 AM">10:00 AM - 11:00 AM</option>
                        <option value="11:00 AM - 12:00 PM">11:00 AM - 12:00 PM</option>
                        <option value="12:00 PM - 1:00 PM">12:00 PM - 1:00 PM</option>
                        <option value="2:00 PM - 3:00 PM">2:00 PM - 3:00 PM</option>
                        <option value="3:00 PM - 4:00 PM">3:00 PM - 4:00 PM</option>
                        <option value="4:00 PM - 5:00 PM">4:00 PM - 5:00 PM</option>
                    </select>
                </div>
                <button id="applyFiltersBtn" class="btn-secondary">Apply Filters</button>
                <button id="clearFiltersBtn" class="btn-outline">Clear</button>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="loading-state">
                <div class="spinner"></div>
                <p>Loading sections...</p>
            </div>

            <!-- Error State -->
            <div id="errorState" class="error-state" style="display: none;">
                <div class="error-icon">‚ö†Ô∏è</div>
                <h3>Error Loading Sections</h3>
                <p id="errorMessage"></p>
                <button id="retryBtn" class="btn-primary">Retry</button>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-icon">üìö</div>
                <h3>No Sections Found</h3>
                <p>No sections registered yet. Add your first section to get started.</p>
            </div>

            <!-- Sections Grid -->
            <div id="sectionsGrid" class="sections-grid" style="display: none;">
                <!-- Sections will be dynamically inserted -->
            </div>
        </div>
    </main>

    <!-- Add/Edit Section Modal -->
    <div id="sectionModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="modalTitle">Add New Section</h3>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <form id="sectionForm" class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Section Name *</label>
                        <input type="text" id="sectionName" class="form-input" placeholder="e.g., CSE-A1" required>
                    </div>
                    <div class="form-group">
                        <label>Department *</label>
                        <input type="text" id="department" class="form-input" placeholder="e.g., Computer Science"
                            required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Class Strength *</label>
                        <input type="number" id="classStrength" class="form-input" placeholder="Number of students"
                            min="1" required>
                    </div>
                    <div class="form-group">
                        <label>Required Duration (hours) *</label>
                        <input type="number" id="requiredDuration" class="form-input" placeholder="e.g., 1 or 2" min="1"
                            max="8" step="0.5" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Time Slot *</label>
                        <select id="timeSlot" class="form-input" required>
                            <option value="">Select Time Slot</option>
                            <option value="8:00 AM - 9:00 AM">8:00 AM - 9:00 AM</option>
                            <option value="9:00 AM - 10:00 AM">9:00 AM - 10:00 AM</option>
                            <option value="10:00 AM - 11:00 AM">10:00 AM - 11:00 AM</option>
                            <option value="11:00 AM - 12:00 PM">11:00 AM - 12:00 PM</option>
                            <option value="12:00 PM - 1:00 PM">12:00 PM - 1:00 PM</option>
                            <option value="2:00 PM - 3:00 PM">2:00 PM - 3:00 PM</option>
                            <option value="3:00 PM - 4:00 PM">3:00 PM - 4:00 PM</option>
                            <option value="4:00 PM - 5:00 PM">4:00 PM - 5:00 PM</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Preferred Room Type</label>
                        <select id="preferredRoomType" class="form-input">
                            <option value="">No Preference</option>
                            <option value="classroom">Classroom</option>
                            <option value="lab">Lab</option>
                            <option value="seminar hall">Seminar Hall</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Additional Requirements</label>
                    <textarea id="additionalRequirements" class="form-input" rows="3"
                        placeholder="Optional: Any specific requirements or notes"></textarea>
                </div>

                <div class="form-error" id="formError" style="display: none;"></div>

                <div class="modal-footer">
                    <button type="button" class="btn-secondary" id="cancelBtn">Cancel</button>
                    <button type="submit" class="btn-primary" id="submitBtn">Save Section</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import {
            getAuth,
            onAuthStateChanged,
            signOut
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import {
            getFirestore,
            collection,
            query,
            getDocs,
            getDoc,
            doc,
            addDoc,
            updateDoc,
            deleteDoc,
            serverTimestamp,
            orderBy
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCRPtDpV7gTzQN0gQKZqZTN4wjps-zgXnU",
            authDomain: "edusync-eaa2b.firebaseapp.com",
            projectId: "edusync-eaa2b",
            storageBucket: "edusync-eaa2b.firebasestorage.app",
            messagingSenderId: "252728058530",
            appId: "1:252728058530:web:96018ca65912c6c6a2adfb"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global State
        let currentUser = null;
        let userRole = null;
        let allSections = [];
        let editingSectionId = null;

        // DOM Elements
        const userName = document.getElementById('userName');
        const userRoleBadge = document.getElementById('userRole');
        const logoutBtn = document.getElementById('logoutBtn');
        const addSectionBtn = document.getElementById('addSectionBtn');
        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');
        const emptyState = document.getElementById('emptyState');
        const sectionsGrid = document.getElementById('sectionsGrid');
        const sectionModal = document.getElementById('sectionModal');
        const sectionForm = document.getElementById('sectionForm');
        const closeModal = document.getElementById('closeModal');
        const cancelBtn = document.getElementById('cancelBtn');
        const applyFiltersBtn = document.getElementById('applyFiltersBtn');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        const retryBtn = document.getElementById('retryBtn');

        // Authentication
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await checkUserRole();
                await loadSections();
            } else {
                window.location.href = '/login';
            }
        });

        // Check User Role
        async function checkUserRole() {
            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));

                if (!userDoc.exists()) {
                    alert('User profile not found. Please contact administrator.');
                    await signOut(auth);
                    return;
                }

                const userData = userDoc.data();
                userRole = userData.role;

                // Authorization check
                if (!['faculty', 'admin'].includes(userRole)) {
                    alert('Access denied. Faculty or Admin role required.');
                    await signOut(auth);
                    return;
                }

                // Update UI
                userName.textContent = userData.email || currentUser.email;
                userRoleBadge.textContent = userRole.toUpperCase();
                userRoleBadge.className = `user-role-badge role-${userRole}`;

            } catch (error) {
                console.error('Error checking role:', error);
                alert('Error verifying permissions.');
            }
        }

        // Load Sections
        async function loadSections() {
            try {
                showLoading();

                const sectionsRef = collection(db, 'sections');
                const q = query(sectionsRef, orderBy('sectionName', 'asc'));
                const snapshot = await getDocs(q);

                allSections = [];
                const departments = new Set();

                snapshot.forEach(doc => {
                    const data = doc.data();
                    allSections.push({
                        id: doc.id,
                        ...data
                    });
                    departments.add(data.department);
                });

                // Populate department filter
                const filterDept = document.getElementById('filterDepartment');
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept;
                    option.textContent = dept;
                    filterDept.appendChild(option);
                });

                if (allSections.length === 0) {
                    showEmpty();
                } else {
                    displaySections(allSections);
                }

            } catch (error) {
                console.error('Error loading sections:', error);
                showError(error.message);
            }
        }

        // Display Sections
        function displaySections(sections) {
            sectionsGrid.innerHTML = '';

            sections.forEach(section => {
                const card = createSectionCard(section);
                sectionsGrid.appendChild(card);
            });

            showSections();
        }

        // Create Section Card
        function createSectionCard(section) {
            const card = document.createElement('div');
            card.className = 'section-card';

            card.innerHTML = `
                <div class="section-card-header">
                    <h3 class="section-name">${escapeHtml(section.sectionName)}</h3>
                    <span class="department-badge">${escapeHtml(section.department)}</span>
                </div>
                <div class="section-card-body">
                    <div class="section-info">
                        <span class="info-icon">üë•</span>
                        <span class="info-text">Strength: ${section.classStrength} students</span>
                    </div>
                    <div class="section-info">
                        <span class="info-icon">‚è±Ô∏è</span>
                        <span class="info-text">Duration: ${section.requiredDuration} hours</span>
                    </div>
                    <div class="section-info">
                        <span class="info-icon">üïê</span>
                        <span class="info-text">${escapeHtml(section.timeSlot)}</span>
                    </div>
                    ${section.preferredRoomType ? `
                        <div class="section-info">
                            <span class="info-icon">üèõÔ∏è</span>
                            <span class="info-text">Prefers: ${capitalizeFirst(section.preferredRoomType)}</span>
                        </div>
                    ` : ''}
                    ${section.additionalRequirements ? `
                        <p class="section-requirements">${escapeHtml(section.additionalRequirements)}</p>
                    ` : ''}
                </div>
                <div class="section-card-footer">
                    <button class="btn-outline btn-sm" onclick="window.editSection('${section.id}')">‚úèÔ∏è Edit</button>
                    <button class="btn-danger btn-sm" onclick="window.deleteSection('${section.id}')">üóëÔ∏è Delete</button>
                </div>
            `;

            return card;
        }

        // Modal Functions
        addSectionBtn.addEventListener('click', () => {
            editingSectionId = null;
            document.getElementById('modalTitle').textContent = 'Add New Section';
            sectionForm.reset();
            document.getElementById('formError').style.display = 'none';
            sectionModal.style.display = 'flex';
        });

        closeModal.addEventListener('click', () => {
            sectionModal.style.display = 'none';
        });

        cancelBtn.addEventListener('click', () => {
            sectionModal.style.display = 'none';
        });

        // Edit Section (Global function)
        window.editSection = async (sectionId) => {
            editingSectionId = sectionId;
            const section = allSections.find(s => s.id === sectionId);

            if (!section) return;

            document.getElementById('modalTitle').textContent = 'Edit Section';
            document.getElementById('sectionName').value = section.sectionName;
            document.getElementById('department').value = section.department;
            document.getElementById('classStrength').value = section.classStrength;
            document.getElementById('requiredDuration').value = section.requiredDuration;
            document.getElementById('timeSlot').value = section.timeSlot;
            document.getElementById('preferredRoomType').value = section.preferredRoomType || '';
            document.getElementById('additionalRequirements').value = section.additionalRequirements || '';
            document.getElementById('formError').style.display = 'none';

            sectionModal.style.display = 'flex';
        };

        // Delete Section (Global function)
        window.deleteSection = async (sectionId) => {
            if (!confirm('Are you sure you want to delete this section? This action cannot be undone.')) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'sections', sectionId));
                alert('Section deleted successfully.');
                await loadSections();
            } catch (error) {
                console.error('Delete error:', error);
                alert('Failed to delete section: ' + error.message);
            }
        };

        // Form Submit
        sectionForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formError = document.getElementById('formError');
            const submitBtn = document.getElementById('submitBtn');

            try {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Saving...';
                formError.style.display = 'none';

                const sectionData = {
                    sectionName: document.getElementById('sectionName').value.trim(),
                    department: document.getElementById('department').value.trim(),
                    classStrength: parseInt(document.getElementById('classStrength').value),
                    requiredDuration: parseFloat(document.getElementById('requiredDuration').value),
                    timeSlot: document.getElementById('timeSlot').value,
                    preferredRoomType: document.getElementById('preferredRoomType').value || '',
                    additionalRequirements: document.getElementById('additionalRequirements').value.trim() || '',
                    updatedAt: serverTimestamp(),
                    updatedBy: currentUser.uid
                };

                if (editingSectionId) {
                    // Update
                    await updateDoc(doc(db, 'sections', editingSectionId), sectionData);
                    alert('Section updated successfully.');
                } else {
                    // Create
                    sectionData.createdAt = serverTimestamp();
                    sectionData.createdBy = currentUser.uid;
                    await addDoc(collection(db, 'sections'), sectionData);
                    alert('Section added successfully.');
                }

                sectionModal.style.display = 'none';
                await loadSections();

            } catch (error) {
                console.error('Form error:', error);
                formError.textContent = error.message;
                formError.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Section';
            }
        });

        // Filters
        applyFiltersBtn.addEventListener('click', () => {
            const deptFilter = document.getElementById('filterDepartment').value;
            const timeFilter = document.getElementById('filterTimeSlot').value;

            const filtered = allSections.filter(section => {
                return (
                    (!deptFilter || section.department === deptFilter) &&
                    (!timeFilter || section.timeSlot === timeFilter)
                );
            });

            displaySections(filtered);
        });

        clearFiltersBtn.addEventListener('click', () => {
            document.getElementById('filterDepartment').value = '';
            document.getElementById('filterTimeSlot').value = '';
            displaySections(allSections);
        });

        // Logout
        logoutBtn.addEventListener('click', async () => {
            await signOut(auth);
            window.location.href = '/login';
        });

        // Retry
        retryBtn.addEventListener('click', loadSections);

        // UI State
        function showLoading() {
            loadingState.style.display = 'flex';
            errorState.style.display = 'none';
            emptyState.style.display = 'none';
            sectionsGrid.style.display = 'none';
        }

        function showError(message) {
            loadingState.style.display = 'none';
            errorState.style.display = 'flex';
            emptyState.style.display = 'none';
            sectionsGrid.style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
        }

        function showEmpty() {
            loadingState.style.display = 'none';
            errorState.style.display = 'none';
            emptyState.style.display = 'flex';
            sectionsGrid.style.display = 'none';
        }

        function showSections() {
            loadingState.style.display = 'none';
            errorState.style.display = 'none';
            emptyState.style.display = 'none';
            sectionsGrid.style.display = 'grid';
        }

        // Utility
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
    </script>
</body>

</html>
