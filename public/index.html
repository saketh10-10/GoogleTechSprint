<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Auth Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        input { padding: 8px; margin: 5px; width: 200px; }
    </style>
</head>
<body>
    <h1>Firebase Authentication Test</h1>

    <div class="test-section">
        <h2>Firebase Connection Test</h2>
        <button onclick="testFirebaseConnection()">Test Firebase Connection</button>
        <div id="connection-result"></div>
    </div>

    <div class="test-section">
        <h2>üîê Student Login Test (Existing Accounts Only)</h2>
        <p><em>Use this to authenticate students who already have accounts</em></p>
        <input type="text" id="student-roll" placeholder="Roll Number (e.g., 2410030001)" value="2410030001">
        <input type="password" id="student-pass" placeholder="Password" value="Student@123">
        <button onclick="testStudentLogin()">Login Student</button>
        <div id="student-result"></div>
    </div>

    <div class="test-section">
        <h2>üìù Student Signup Test (Create New Accounts)</h2>
        <p><em>Use this to create NEW student accounts. Will fail if account exists.</em></p>
        <input type="text" id="student-signup-roll" placeholder="Roll Number (e.g., 2410030002)" value="2410030002">
        <input type="password" id="student-signup-pass" placeholder="Password (min 6 chars)" value="Student@123">
        <button onclick="testStudentSignup()">Create Student Account</button>
        <div id="student-signup-result"></div>
    </div>

    <div class="test-section">
        <h2>üîê Faculty Login Test (Existing Accounts Only)</h2>
        <p><em>Use this to authenticate faculty who already have accounts</em></p>
        <input type="email" id="faculty-email" placeholder="Email" value="faculty@klh.edu.in">
        <input type="password" id="faculty-pass" placeholder="Password" value="Faculty@123">
        <button onclick="testFacultyLogin()">Login Faculty</button>
        <div id="faculty-result"></div>
    </div>

    <div class="test-section">
        <h2>üìù Faculty Signup Test (Create New Accounts)</h2>
        <p><em>Use this to create NEW faculty accounts. Will fail if account exists.</em></p>
        <input type="email" id="faculty-signup-email" placeholder="Email" value="newfaculty@klh.edu.in">
        <input type="password" id="faculty-signup-pass" placeholder="Password (min 6 chars)" value="Faculty@123">
        <button onclick="testFacultySignup()">Create Faculty Account</button>
        <div id="faculty-signup-result"></div>
    </div>

    <script type="module">
        // Firebase Configuration (same as main app)
        const firebaseConfig = {
            apiKey: "AIzaSyCRPtDpV7gTzQN0gQKZqZTN4wjps-zgXnU",
            authDomain: "edusync-eaa2b.firebaseapp.com",
            projectId: "edusync-eaa2b",
            storageBucket: "edusync-eaa2b.firebasestorage.app",
            messagingSenderId: "252728058530",
            appId: "1:252728058530:web:96018ca65912c6c6a2adfb"
        };

        // Import Firebase modules (same as main app)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // Initialize Firebase (same as main app)
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Import authentication service functions (simulated for this test page)
        // In a real app, you'd import from './lib/auth-service.js'
        const signInStudent = async (rollNumber, password) => {
            try {
                const email = `${rollNumber.trim()}@klh.student`;
                console.log('üîê STUDENT LOGIN: Attempting authentication for', email);

                const { signInWithEmailAndPassword } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js");
                const userCredential = await signInWithEmailAndPassword(auth, email, password);

                console.log('‚úÖ STUDENT LOGIN SUCCESS: User authenticated', userCredential.user.uid);
                return {
                    success: true,
                    user: userCredential.user,
                    message: 'Student login successful!'
                };
            } catch (error) {
                console.error('‚ùå STUDENT LOGIN ERROR:', error?.code, error?.message);
                return {
                    success: false,
                    error: error?.code || 'unknown-error',
                    message: getAuthErrorMessage(error?.code)
                };
            }
        };

        const registerStudent = async (rollNumber, password) => {
            try {
                const email = `${rollNumber.trim()}@klh.student`;
                console.log('üìù STUDENT SIGNUP: Creating new account for', email);

                const { createUserWithEmailAndPassword } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js");
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);

                console.log('‚úÖ STUDENT SIGNUP SUCCESS: New account created', userCredential.user.uid);
                return {
                    success: true,
                    user: userCredential.user,
                    message: 'Student account created successfully!'
                };
            } catch (error) {
                console.error('‚ùå STUDENT SIGNUP ERROR:', error?.code, error?.message);
                return {
                    success: false,
                    error: error?.code || 'unknown-error',
                    message: getAuthErrorMessage(error?.code)
                };
            }
        };

        const signInFaculty = async (email, password) => {
            try {
                console.log('üîê FACULTY LOGIN: Attempting authentication for', email.trim());

                const { signInWithEmailAndPassword } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js");
                const userCredential = await signInWithEmailAndPassword(auth, email.trim(), password);

                console.log('‚úÖ FACULTY LOGIN SUCCESS: User authenticated', userCredential.user.uid);
                return {
                    success: true,
                    user: userCredential.user,
                    message: 'Faculty login successful!'
                };
            } catch (error) {
                console.error('‚ùå FACULTY LOGIN ERROR:', error?.code, error?.message);
                return {
                    success: false,
                    error: error?.code || 'unknown-error',
                    message: getAuthErrorMessage(error?.code)
                };
            }
        };

        const registerFaculty = async (email, password) => {
            try {
                console.log('üìù FACULTY SIGNUP: Creating new account for', email.trim());

                const { createUserWithEmailAndPassword } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js");
                const userCredential = await createUserWithEmailAndPassword(auth, email.trim(), password);

                console.log('‚úÖ FACULTY SIGNUP SUCCESS: New account created', userCredential.user.uid);
                return {
                    success: true,
                    user: userCredential.user,
                    message: 'Faculty account created successfully!'
                };
            } catch (error) {
                console.error('‚ùå FACULTY SIGNUP ERROR:', error?.code, error?.message);
                return {
                    success: false,
                    error: error?.code || 'unknown-error',
                    message: getAuthErrorMessage(error?.code)
                };
            }
        };

        const getAuthErrorMessage = (errorCode) => {
            // Handle undefined/null error codes
            if (!errorCode) {
                return 'An unexpected error occurred. Please try again.';
            }

            switch (errorCode) {
                case 'auth/email-already-in-use':
                    return 'Account already exists. Please use the login form instead.';
                case 'auth/weak-password':
                    return 'Password is too weak. Please use at least 6 characters.';
                case 'auth/user-not-found':
                    return 'Account does not exist. Please sign up first.';
                case 'auth/wrong-password':
                    return 'Incorrect password. Please try again.';
                case 'auth/invalid-credential':
                    return 'Invalid credentials. Please check your input.';
                case 'auth/invalid-email':
                    return 'Invalid email format.';
                case 'auth/user-disabled':
                    return 'This account has been disabled.';
                case 'auth/network-request-failed':
                    return 'Network error. Check your connection.';
                case 'auth/too-many-requests':
                    return 'Too many attempts. Please wait and try again.';
                default:
                    return 'An unexpected error occurred. Please try again.';
            }
        };

        window.testFirebaseConnection = function() {
            const resultDiv = document.getElementById('connection-result');
            resultDiv.innerHTML = 'Testing Firebase connection...';

            try {
                // Just check if auth is initialized
                if (auth) {
                    resultDiv.innerHTML = '<span class="success">‚úÖ Firebase connection successful!</span>';
                } else {
                    resultDiv.innerHTML = '<span class="error">‚ùå Firebase connection failed!</span>';
                }
            } catch (error) {
                resultDiv.innerHTML = '<span class="error">‚ùå Error: ' + error.message + '</span>';
            }
        };

        window.testStudentLogin = async function() {
            const rollNumber = document.getElementById('student-roll').value;
            const password = document.getElementById('student-pass').value;
            const resultDiv = document.getElementById('student-result');

            resultDiv.innerHTML = 'üîê Authenticating student...';

            const result = await signInStudent(rollNumber, password);

            if (result.success) {
                resultDiv.innerHTML = `<span class="success">‚úÖ ${result.message} (UID: ${result.user.uid})</span>`;
            } else {
                resultDiv.innerHTML = `<span class="error">‚ùå ${result.message}</span>`;
            }
        };

        window.testStudentSignup = async function() {
            const rollNumber = document.getElementById('student-signup-roll').value;
            const password = document.getElementById('student-signup-pass').value;
            const resultDiv = document.getElementById('student-signup-result');

            resultDiv.innerHTML = 'üìù Creating student account...';

            const result = await registerStudent(rollNumber, password);

            if (result.success) {
                resultDiv.innerHTML = `<span class="success">‚úÖ ${result.message} (UID: ${result.user.uid})</span>`;
            } else {
                resultDiv.innerHTML = `<span class="error">‚ùå ${result.message}</span>`;
            }
        };

        window.testFacultyLogin = async function() {
            const email = document.getElementById('faculty-email').value;
            const password = document.getElementById('faculty-pass').value;
            const resultDiv = document.getElementById('faculty-result');

            resultDiv.innerHTML = 'üîê Authenticating faculty...';

            const result = await signInFaculty(email, password);

            if (result.success) {
                resultDiv.innerHTML = `<span class="success">‚úÖ ${result.message} (UID: ${result.user.uid})</span>`;
            } else {
                resultDiv.innerHTML = `<span class="error">‚ùå ${result.message}</span>`;
            }
        };

        window.testFacultySignup = async function() {
            const email = document.getElementById('faculty-signup-email').value;
            const password = document.getElementById('faculty-signup-pass').value;
            const resultDiv = document.getElementById('faculty-signup-result');

            resultDiv.innerHTML = 'üìù Creating faculty account...';

            const result = await registerFaculty(email, password);

            if (result.success) {
                resultDiv.innerHTML = `<span class="success">‚úÖ ${result.message} (UID: ${result.user.uid})</span>`;
            } else {
                resultDiv.innerHTML = `<span class="error">‚ùå ${result.message}</span>`;
            }
        };

        // Auto-test Firebase connection on page load
        window.addEventListener('load', function() {
            setTimeout(testFirebaseConnection, 1000);
        });
    </script>
</body>
</html>
