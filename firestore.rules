rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to get today's date (start of day)
    function isToday(eventTime) {
      return eventTime.toMillis() >= request.time.toMillis().truncate(duration.value(1, 'd'))
        && eventTime.toMillis() < request.time.toMillis().truncate(duration.value(1, 'd')) + duration.value(1, 'd').toMillis();
    }
    
    // ============================================
    // EVENTS COLLECTION
    // ============================================
    match /events/{eventId} {
      // Students can READ only today's events
      // Event date must be today
      allow read: if isAuthenticated() 
                  && resource.data.date is timestamp
                  && isToday(resource.data.date);
      
      // Only admins/backend can write events
      // Students CANNOT create, update, or delete events
      allow write: if false; // Backend only via Admin SDK
    }
    
    // ============================================
    // QR SESSIONS COLLECTION
    // ============================================
    match /qr_sessions/{sessionId} {
      // Students can CREATE only their own QR sessions
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.keys().hasAll(['userId', 'eventId', 'nonce', 'createdAt', 'expiresAt', 'used'])
                    && request.resource.data.used == false
                    && request.resource.data.createdAt is timestamp
                    && request.resource.data.expiresAt is timestamp
                    // Ensure expiry is within 2 minutes
                    && request.resource.data.expiresAt.toMillis() <= request.resource.data.createdAt.toMillis() + 120000;
      
      // Students can READ only their own QR sessions
      allow read: if isAuthenticated() 
                  && resource.data.userId == request.auth.uid;
      
      // Students CANNOT update or delete QR sessions
      // Only backend can mark as 'used'
      allow update: if false; // Backend only
      allow delete: if false; // Backend only
    }
    
    // ============================================
    // ATTENDANCE COLLECTION
    // ============================================
    match /attendance/{attendanceId} {
      // Students can READ only their own attendance records
      allow read: if isAuthenticated() 
                  && resource.data.userId == request.auth.uid;
      
      // Students CANNOT write attendance records
      // Only backend via Cloud Functions can create attendance
      allow write: if false; // Backend only via Admin SDK
    }
    
    // ============================================
    // USERS COLLECTION (RBAC - Role Management)
    // ============================================
    match /users/{userId} {
      // Helper: Check if user is admin
      function isAdmin() {
        return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      // Helper: Check if user is faculty or admin
      function isFacultyOrAdmin() {
        return isAuthenticated() && 
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['faculty', 'admin'];
      }
      
      // Users can read their own profile
      allow read: if isOwner(userId);
      
      // Users can update their own profile (limited fields, NOT role)
      allow update: if isOwner(userId)
                    && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'createdAt']);
      
      // Only backend can create/delete user profiles
      allow create, delete: if false;
    }
    
    // ============================================
    // ROOMS COLLECTION (RBAC Protected)
    // ============================================
    match /rooms/{roomId} {
      // Helper: Check if user is faculty or admin
      function isFacultyOrAdmin() {
        return isAuthenticated() && 
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['faculty', 'admin'];
      }
      
      // Helper: Check if user is admin
      function isAdmin() {
        return isAuthenticated() && 
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      // Faculty and Admin can READ rooms
      allow read: if isFacultyOrAdmin();
      
      // Only Admin can CREATE rooms
      allow create: if isAdmin()
                    && request.resource.data.keys().hasAll(['roomName', 'roomNumber', 'capacity', 'roomType', 'availabilityStatus', 'createdAt', 'createdBy'])
                    && request.resource.data.capacity is int
                    && request.resource.data.capacity > 0
                    && request.resource.data.roomType in ['classroom', 'lab', 'seminar hall']
                    && request.resource.data.availabilityStatus in ['available', 'unavailable'];
      
      // Admin can UPDATE rooms, Faculty can update availability only
      allow update: if isAdmin()
                    || (isFacultyOrAdmin() && 
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['availabilityStatus', 'updatedAt', 'updatedBy']));
      
      // Only Admin can DELETE rooms
      allow delete: if isAdmin();
    }
    
    // ============================================
    // SECTIONS COLLECTION (RBAC Protected)
    // ============================================
    match /sections/{sectionId} {
      // Helper: Check if user is faculty or admin
      function isFacultyOrAdmin() {
        return isAuthenticated() && 
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['faculty', 'admin'];
      }
      
      // Faculty and Admin can READ sections
      allow read: if isFacultyOrAdmin();
      
      // Faculty and Admin can CREATE sections
      allow create: if isFacultyOrAdmin()
                    && request.resource.data.keys().hasAll(['sectionName', 'department', 'classStrength', 'createdAt', 'createdBy'])
                    && request.resource.data.classStrength is int
                    && request.resource.data.classStrength > 0;
      
      // Faculty and Admin can UPDATE sections
      allow update: if isFacultyOrAdmin();
      
      // Faculty and Admin can DELETE sections
      allow delete: if isFacultyOrAdmin();
    }
    
    // ============================================
    // ALLOCATIONS COLLECTION (RBAC Protected)
    // ============================================
    match /allocations/{allocationId} {
      // Helper: Check if user is faculty or admin
      function isFacultyOrAdmin() {
        return isAuthenticated() && 
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['faculty', 'admin'];
      }
      
      // Faculty and Admin can READ allocations
      allow read: if isFacultyOrAdmin();
      
      // Only backend can CREATE allocations (via Cloud Function)
      // This ensures validation logic is enforced
      allow create: if false;
      
      // Only backend can UPDATE allocations
      allow update: if false;
      
      // Faculty and Admin can DELETE allocations (cancellation)
      allow delete: if isFacultyOrAdmin();
    }
    
    // ============================================
    // AI SUGGESTIONS COLLECTION (Temporary Storage)
    // ============================================
    match /ai_suggestions/{suggestionId} {
      // Helper: Check if user is faculty or admin
      function isFacultyOrAdmin() {
        return isAuthenticated() && 
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['faculty', 'admin'];
      }
      
      // Faculty and Admin can READ suggestions
      allow read: if isFacultyOrAdmin();
      
      // Only backend can CREATE suggestions
      allow create: if false;
      
      // No updates or deletes (suggestions are temporary)
      allow update, delete: if false;
    }
    
    // ============================================
    // DENY ALL OTHER COLLECTIONS
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
