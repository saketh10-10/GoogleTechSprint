rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to get today's date (start of day)
    function isToday(eventTime) {
      return eventTime.toMillis() >= request.time.toMillis().truncate(duration.value(1, 'd'))
        && eventTime.toMillis() < request.time.toMillis().truncate(duration.value(1, 'd')) + duration.value(1, 'd').toMillis();
    }
    
    // ============================================
    // EVENTS COLLECTION
    // ============================================
    match /events/{eventId} {
      // Students can READ only today's events
      // Event date must be today
      allow read: if isAuthenticated() 
                  && resource.data.date is timestamp
                  && isToday(resource.data.date);
      
      // Only admins/backend can write events
      // Students CANNOT create, update, or delete events
      allow write: if false; // Backend only via Admin SDK
    }
    
    // ============================================
    // QR SESSIONS COLLECTION
    // ============================================
    match /qrSessions/{sessionId} {
      // Client CANNOT write to qrSessions collection
      // Only Cloud Functions can create QR sessions
      allow create: if false; // Backend only via Cloud Functions

      // Users can read QR sessions for validation (but Cloud Functions handle the actual validation)
      allow read: if isAuthenticated();

      // Client CANNOT update or delete QR sessions
      // Only Cloud Functions can mark as 'used'
      allow update: if false; // Backend only via Cloud Functions
      allow delete: if false; // Backend only via Cloud Functions
    }
    
    // ============================================
    // ATTENDANCE COLLECTION
    // ============================================
    match /attendance/{attendanceId} {
      // Users can READ attendance records (for viewing their own attendance)
      allow read: if isAuthenticated()
                  && resource.data.userId == request.auth.uid;

      // Client CANNOT write to attendance collection
      // Only Cloud Functions can create attendance records
      allow create: if false; // Backend only via Cloud Functions
      allow update: if false; // Backend only via Cloud Functions
      allow delete: if false; // Backend only via Cloud Functions
    }
    
    // ============================================
    // USERS COLLECTION (RBAC - Role Management)
    // ============================================
    match /users/{userId} {
      // Helper: Check if user is admin
      function isAdmin() {
        return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      // Helper: Check if user is faculty or admin
      function isFacultyOrAdmin() {
        return isAuthenticated() && 
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['faculty', 'admin'];
      }
      
      // Users can read their own profile
      allow read: if isOwner(userId);
      
      // Users can update their own profile (limited fields, NOT role)
      allow update: if isOwner(userId)
                    && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'createdAt']);
      
      // Only backend can create/delete user profiles
      allow create, delete: if false;
    }
    
    // ============================================
    // ROOMS COLLECTION (RBAC Protected)
    // ============================================
    match /rooms/{roomId} {
      // Helper: Check if user is faculty or admin
      function isFacultyOrAdmin() {
        return isAuthenticated() &&
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['faculty', 'admin'];
      }

      // Helper: Check if user is admin
      function isAdmin() {
        return isAuthenticated() &&
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }

      // Faculty and Admin can READ rooms
      allow read: if isFacultyOrAdmin();

      // Only backend can CREATE rooms (via Cloud Function)
      // This ensures validation and prevents duplicate room names
      allow create: if false;

      // Only backend can UPDATE rooms
      allow update: if false;

      // Only Admin can DELETE rooms
      allow delete: if isAdmin();
    }
    
    // ============================================
    // SECTIONS COLLECTION (RBAC Protected)
    // ============================================
    match /sections/{sectionId} {
      // Helper: Check if user is faculty or admin
      function isFacultyOrAdmin() {
        return isAuthenticated() &&
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['faculty', 'admin'];
      }

      // Faculty and Admin can READ sections
      allow read: if isFacultyOrAdmin();

      // Only backend can CREATE sections (via Cloud Function)
      // This ensures validation and prevents duplicate sections
      allow create: if false;

      // Faculty and Admin can UPDATE sections
      allow update: if isFacultyOrAdmin();

      // Faculty and Admin can DELETE sections
      allow delete: if isFacultyOrAdmin();
    }
    
    // ============================================
    // ALLOCATIONS COLLECTION (RBAC Protected)
    // ============================================
    match /allocations/{allocationId} {
      // Helper: Check if user is faculty or admin
      function isFacultyOrAdmin() {
        return isAuthenticated() &&
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['faculty', 'admin'];
      }

      // Faculty and Admin can READ allocations
      allow read: if isFacultyOrAdmin();

      // Only backend can CREATE allocations (via Cloud Function)
      // This ensures conflict detection and validation logic is enforced
      allow create: if false;

      // Only backend can UPDATE allocations
      allow update: if false;

      // Faculty and Admin can DELETE allocations (cancellation)
      allow delete: if isFacultyOrAdmin();
    }
    
    // ============================================
    // AI SUGGESTIONS COLLECTION (Temporary Storage)
    // ============================================
    match /ai_suggestions/{suggestionId} {
      // Helper: Check if user is faculty or admin
      function isFacultyOrAdmin() {
        return isAuthenticated() && 
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['faculty', 'admin'];
      }
      
      // Faculty and Admin can READ suggestions
      allow read: if isFacultyOrAdmin();
      
      // Only backend can CREATE suggestions
      allow create: if false;
      
      // No updates or deletes (suggestions are temporary)
      allow update, delete: if false;
    }

    // ============================================
    // ISSUEHUB SYSTEM - QUESTIONS & ANSWERS
    // ============================================
    match /questions/{questionId} {
      // Helper: Check if user is authenticated student
      function isAuthenticatedStudent() {
        return isAuthenticated() &&
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'student';
      }

      // Students can read all questions
      allow read: if isAuthenticatedStudent();

      // Only backend can create questions (via createQuestion Cloud Function)
      // This ensures validation and duplicate detection
      allow create: if false;

      // Students can update their own questions (limited fields only)
      allow update: if isAuthenticatedStudent() &&
                   resource.data.createdBy == request.auth.uid &&
                   request.resource.data.diff(resource.data).affectedKeys()
                     .hasOnly(['title', 'description', 'tags']);

      // Students can delete their own questions
      allow delete: if isAuthenticatedStudent() &&
                   resource.data.createdBy == request.auth.uid;
    }

    // ============================================
    // ANSWERS COLLECTION
    // ============================================
    match /answers/{answerId} {
      // Helper: Check if user is authenticated student
      function isAuthenticatedStudent() {
        return isAuthenticated() &&
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'student';
      }

      // Students can read all answers
      allow read: if isAuthenticatedStudent();

      // Only backend can create answers (via postAnswer Cloud Function)
      // This ensures proper question counter updates
      allow create: if false;

      // Students can update their own answers
      allow update: if isAuthenticatedStudent() &&
                   resource.data.createdBy == request.auth.uid;

      // Students can delete their own answers
      allow delete: if isAuthenticatedStudent() &&
                   resource.data.createdBy == request.auth.uid;
    }

    // ============================================
    // UPVOTES COLLECTIONS (Prevent duplicates)
    // ============================================
    match /questionUpvotes/{upvoteId} {
      // Only backend can create upvote records (via upvoteQuestion Cloud Function)
      allow create: if false;
      allow read, update, delete: if false; // No client access
    }

    match /answerUpvotes/{upvoteId} {
      // Only backend can create upvote records (via upvoteAnswer Cloud Function)
      allow create: if false;
      allow read, update, delete: if false; // No client access
    }

    // ============================================
    // LEADERBOARD COLLECTION
    // ============================================
    match /leaderboard/{documentId} {
      // Anyone can read leaderboard (for display)
      allow read: if true;

      // Only backend can create/update leaderboard (via generateLeaderboard Cloud Function)
      allow write: if false;
    }

    // ============================================
    // USERS COLLECTION - METRICS PROTECTION
    // ============================================
    match /users/{userId} {
      // Helper: Check if user is admin
      function isAdmin() {
        return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }

      // Users can read their own profile and other users' basic info
      allow read: if true;

      // Users can update their own profile (excluding protected metrics)
      allow update: if isOwner(userId) &&
                   !request.resource.data.diff(resource.data).affectedKeys()
                     .hasAny(['questionsPosted', 'answersPosted', 'totalUpvotes',
                             'followersCount', 'followingCount']);

      // Only backend can update metrics (questionsPosted, answersPosted, totalUpvotes)
      // This prevents cheating and ensures data integrity

      // Only backend can create user profiles
      allow create: if false;

      // Users can delete their own account (admin can delete any)
      allow delete: if isOwner(userId) || isAdmin();
    }

    // ============================================
    // DENY ALL OTHER COLLECTIONS
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
