rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to get today's date (start of day)
    function isToday(eventTime) {
      return eventTime.toMillis() >= request.time.toMillis().truncate(duration.value(1, 'd'))
        && eventTime.toMillis() < request.time.toMillis().truncate(duration.value(1, 'd')) + duration.value(1, 'd').toMillis();
    }
    
    // ============================================
    // EVENTS COLLECTION
    // ============================================
    match /events/{eventId} {
      // Students can READ only today's events
      // Event date must be today
      allow read: if isAuthenticated() 
                  && resource.data.date is timestamp
                  && isToday(resource.data.date);
      
      // Only admins/backend can write events
      // Students CANNOT create, update, or delete events
      allow write: if false; // Backend only via Admin SDK
    }
    
    // ============================================
    // QR SESSIONS COLLECTION
    // ============================================
    match /qrSessions/{sessionId} {
      // Client CANNOT write to qrSessions collection
      // Only Cloud Functions can create QR sessions
      allow create: if false; // Backend only via Cloud Functions

      // Users can read QR sessions for validation (but Cloud Functions handle the actual validation)
      allow read: if isAuthenticated();

      // Client CANNOT update or delete QR sessions
      // Only Cloud Functions can mark as 'used'
      allow update: if false; // Backend only via Cloud Functions
      allow delete: if false; // Backend only via Cloud Functions
    }
    
    // ============================================
    // ATTENDANCE COLLECTION
    // ============================================
    match /attendance/{attendanceId} {
      // Users can READ attendance records (for viewing their own attendance)
      allow read: if isAuthenticated()
                  && resource.data.userId == request.auth.uid;

      // Client CANNOT write to attendance collection
      // Only Cloud Functions can create attendance records
      allow create: if false; // Backend only via Cloud Functions
      allow update: if false; // Backend only via Cloud Functions
      allow delete: if false; // Backend only via Cloud Functions
    }
    
    // ============================================
    // USERS COLLECTION (RBAC - Role Management)
    // ============================================
    match /users/{userId} {
      // Helper: Check if user is admin
      function isAdmin() {
        return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      // Helper: Check if user is faculty or admin
      function isFacultyOrAdmin() {
        return isAuthenticated() && 
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['faculty', 'admin'];
      }
      
      // Users can read their own profile
      allow read: if isOwner(userId);
      
      // Users can update their own profile (limited fields, NOT role)
      allow update: if isOwner(userId)
                    && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'createdAt']);
      
      // Only backend can create/delete user profiles
      allow create, delete: if false;
    }
    
    // ============================================
    // ROOMS COLLECTION (RBAC Protected)
    // ============================================
    match /rooms/{roomId} {
      // Helper: Check if user is faculty or admin
      function isFacultyOrAdmin() {
        return isAuthenticated() &&
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['faculty', 'admin'];
      }

      // Helper: Check if user is admin
      function isAdmin() {
        return isAuthenticated() &&
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }

      // Faculty and Admin can READ rooms
      allow read: if isFacultyOrAdmin();

      // Only backend can CREATE rooms (via Cloud Function)
      // This ensures validation and prevents duplicate room names
      allow create: if false;

      // Only backend can UPDATE rooms
      allow update: if false;

      // Only Admin can DELETE rooms
      allow delete: if isAdmin();
    }
    
    // ============================================
    // SECTIONS COLLECTION (RBAC Protected)
    // ============================================
    match /sections/{sectionId} {
      // Helper: Check if user is faculty or admin
      function isFacultyOrAdmin() {
        return isAuthenticated() &&
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['faculty', 'admin'];
      }

      // Faculty and Admin can READ sections
      allow read: if isFacultyOrAdmin();

      // Only backend can CREATE sections (via Cloud Function)
      // This ensures validation and prevents duplicate sections
      allow create: if false;

      // Faculty and Admin can UPDATE sections
      allow update: if isFacultyOrAdmin();

      // Faculty and Admin can DELETE sections
      allow delete: if isFacultyOrAdmin();
    }
    
    // ============================================
    // ALLOCATIONS COLLECTION (RBAC Protected)
    // ============================================
    match /allocations/{allocationId} {
      // Helper: Check if user is faculty or admin
      function isFacultyOrAdmin() {
        return isAuthenticated() &&
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['faculty', 'admin'];
      }

      // Faculty and Admin can READ allocations
      allow read: if isFacultyOrAdmin();

      // Only backend can CREATE allocations (via Cloud Function)
      // This ensures conflict detection and validation logic is enforced
      allow create: if false;

      // Only backend can UPDATE allocations
      allow update: if false;

      // Faculty and Admin can DELETE allocations (cancellation)
      allow delete: if isFacultyOrAdmin();
    }
    
    // ============================================
    // AI SUGGESTIONS COLLECTION (Temporary Storage)
    // ============================================
    match /ai_suggestions/{suggestionId} {
      // Helper: Check if user is faculty or admin
      function isFacultyOrAdmin() {
        return isAuthenticated() && 
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['faculty', 'admin'];
      }
      
      // Faculty and Admin can READ suggestions
      allow read: if isFacultyOrAdmin();
      
      // Only backend can CREATE suggestions
      allow create: if false;
      
      // No updates or deletes (suggestions are temporary)
      allow update, delete: if false;
    }
    
    // ============================================
    // DENY ALL OTHER COLLECTIONS
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
